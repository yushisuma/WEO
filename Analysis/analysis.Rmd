---
title: "An idea for final project: Predicting one country's economics by other countries' economic indicators"
author: "Yushi Suma"
date: "2019/5/16"
output:
  html_document:
    number_sections: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Idea
## Basic idea
- Regress a country's economic indicator (eg. GDP growth) on other countries indictors (eg. GDP growth).

## Data
- IMF/World Economic Outlook (WEO) Data
    - [Front page](https://www.imf.org/external/pubs/ft/weo/2019/01/weodata/index.aspx)

## My impression
- I'm just curious about it, but I don't know if it is meaningful in light of economic theory.
- I conducted preliminary analysis as below, but I don't know if there will be more interesting findings if we dig into the data.
- Also, I'm not sure such macroeconomic and time-series data is suieted for this course.

# Preliminary analsis
## What I tried
- In this preliminary analysis, I regressed log GDP of one country on other countries' log GDP
- Time frame
    - 1) All data (1980-2018) (LASSO, CV-LASSO, FDR)
    - 2) After 1990 (1990-2018) (LASSO, CV-LASSO)
- Method
    - LASSO: [Japan] ~ [other countries]
    - CV-LASSO: [Japan, Indonesia, US, Germany] ~ [other countries]
    - FDR: [Japan] ~ [each country]
- Results are shown below.

## Data
### Data size
- The dimension of data is log GDP (PPP) of 194 countries (observations) X 39 years (columns), and I used the data of 144 countries which have no NAs.

### Data source
- The csv file I used for this preliminary analysis is generated by the excel file downloaded from [here](https://www.imf.org/external/pubs/ft/weo/2019/01/weodata/weorept.aspx?sy=1980&ey=2018&scsm=1&ssd=1&sort=country&ds=.&br=0&pr1.x=54&pr1.y=8&c=512%2C668%2C914%2C672%2C612%2C946%2C614%2C137%2C311%2C546%2C213%2C674%2C911%2C676%2C314%2C548%2C193%2C556%2C122%2C678%2C912%2C181%2C313%2C867%2C419%2C682%2C513%2C684%2C316%2C273%2C913%2C868%2C124%2C921%2C339%2C948%2C638%2C943%2C514%2C686%2C218%2C688%2C963%2C518%2C616%2C728%2C223%2C836%2C516%2C558%2C918%2C138%2C748%2C196%2C618%2C278%2C624%2C692%2C522%2C694%2C622%2C962%2C156%2C142%2C626%2C449%2C628%2C564%2C228%2C565%2C924%2C283%2C233%2C853%2C632%2C288%2C636%2C293%2C634%2C566%2C238%2C964%2C662%2C182%2C960%2C359%2C423%2C453%2C935%2C968%2C128%2C922%2C611%2C714%2C321%2C862%2C243%2C135%2C248%2C716%2C469%2C456%2C253%2C722%2C642%2C942%2C643%2C718%2C939%2C724%2C734%2C576%2C644%2C936%2C819%2C961%2C172%2C813%2C132%2C726%2C646%2C199%2C648%2C733%2C915%2C184%2C134%2C524%2C652%2C361%2C174%2C362%2C328%2C364%2C258%2C732%2C656%2C366%2C654%2C144%2C336%2C146%2C263%2C463%2C268%2C528%2C532%2C923%2C944%2C738%2C176%2C578%2C534%2C537%2C536%2C742%2C429%2C866%2C433%2C369%2C178%2C744%2C436%2C186%2C136%2C925%2C343%2C869%2C158%2C746%2C439%2C926%2C916%2C466%2C664%2C112%2C826%2C111%2C542%2C298%2C967%2C927%2C443%2C846%2C917%2C299%2C544%2C582%2C941%2C474%2C446%2C754%2C666%2C698&s=NGDPD%2CPPPGDP%2CBCA&grp=0&a=)

### Note
- The number of columns might not be large enough for the purpose of this assignment, but other non-GDP indicators (such as population, unemployment rate, trade/GDP ratio, etc) can be added on the IMF website too. So, we can easily increase the columns (although I'm not sure it is meaningful).

# Preliminary analysis result
## Data loading and distribution of GDP
```{r, message = FALSE}
library(tidyverse)
library(here)
library(broom)
library(furrr)    # for parallel purrr
plan(multiprocess)
library(gamlr)

set.seed(12345)
```

```{r}
data <- read_csv(here("Data/WEO_Data.csv"),
                 na = "n/a",
                 col_types = str_c("ccccc", str_flatten(rep("n", 2018 - 1980 + 1)), "_"))

GDP_USD <- data %>%
  filter(`Subject Descriptor` == "Gross domestic product, current prices",
         Units == "U.S. dollars")

GDP_PPP <- data %>%
  filter(`Subject Descriptor` == "Gross domestic product, current prices",
         Units == "Purchasing power parity; international dollars")

CA <- data %>%
  filter(`Subject Descriptor` == "Current account balance")

```

```{r}
tidy_GDP_PPP <-
  GDP_PPP %>%
  select(-(2:5)) %>%
  gather(key = "year", value = "GDP_PPP", -1) %>%
  group_by(Country) %>%
  arrange(Country, year) %>%
  mutate(log_GDP_PPP = log(GDP_PPP),
         diff_log_GDP_PPP = log_GDP_PPP - lag(log_GDP_PPP),
         growth_rate = GDP_PPP / lag(GDP_PPP))

# distribution of GDP_PPP
tidy_GDP_PPP %>%
  ggplot(aes(x = GDP_PPP)) + geom_histogram() +
    labs(title = "Distribution of GDP_PPP")


# distribution of log_GDP_PPP
tidy_GDP_PPP %>% 
  ggplot(aes(x = log_GDP_PPP)) + geom_histogram() +
    labs(title = "Distribution of log(GDP_PPP)")


# distribution of diff_log_GDP_PPP
tidy_GDP_PPP %>% 
  ggplot(aes(x = diff_log_GDP_PPP)) + geom_histogram()+
    labs(title = "Distribution of log(GDP_PPP)_t - log(GDP_PPP)_t-1")


NAlist_sparse_GDP_PPP <- # countries that includes more than 1 NAs
  tidy_GDP_PPP %>%
  select(1, 2, 5) %>%    # select diff_log_GDP_PPP only
  mutate(isNA = is.na(diff_log_GDP_PPP)) %>%
  group_by(Country) %>%
  summarise(sumNA = sum(isNA)) %>%
  filter(sumNA > 1)
  
sparse_GDP_PPP <-
  tidy_GDP_PPP %>%
  select(1, 2, 5) %>%    # select diff_log_GDP_PPP only
  filter(!(Country %in% NAlist_sparse_GDP_PPP$Country)) %>% # exlude countries which include NAs
  spread(key = "Country", value = "diff_log_GDP_PPP") %>%
  filter(year != 1980)

sparse_GDP_PPP_after1990 <-
  tidy_GDP_PPP %>%
  select(1, 2, 5) %>%    # select diff_log_GDP_PPP only
  filter(!(Country %in% NAlist_sparse_GDP_PPP$Country)) %>% # exlude countries which include NAs
  spread(key = "Country", value = "diff_log_GDP_PPP") %>%
  filter(year != 1980, year >= 1990)
```

## LASSO and CV-LASSO for all data (1981-2018)
```{r}
# JP LASSO
reg_JP <- lm(Japan ~ ., data = sparse_GDP_PPP %>% select(-1))

lasso_JP <- gamlr(x = sparse_GDP_PPP %>% select(-1) %>% select(-Japan),
                  y = sparse_GDP_PPP %>% select(Japan))

plot(lasso_JP)

seg_JP <- names(AICc(lasso_JP))[which.min(AICc(lasso_JP))]
(coef_JP <-
  coef(lasso_JP) %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_JP) %>%
  filter(estimate != 0))

coef_JP %>%
  ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting JP GDP growth (LASSO AICc-minimizing lambda)") +
  coord_flip() +
  theme_bw()

# JP CV-LASSO
cv.lasso_JP <- cv.gamlr(x = sparse_GDP_PPP %>% select(-1) %>% select(-Japan),
                  y = sparse_GDP_PPP %>% select(Japan))

plot(cv.lasso_JP)
plot(cv.lasso_JP$gamlr)
seg_JP <- str_c("seg", cv.lasso_JP$seg.1se)
(coef_cv_JP <-
  coef(cv.lasso_JP, select = "1se") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_JP) %>%
  filter(estimate != 0))

coef_cv_JP %>%
  ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting JP GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()


# Indonesia
reg_ID <- lm(Indonesia ~ ., data = sparse_GDP_PPP %>% select(-1))
cv.lasso_ID <- cv.gamlr(x = sparse_GDP_PPP %>% select(-1) %>% select(-Indonesia),
                  y = sparse_GDP_PPP %>% select(Indonesia),
                  lambda.min.ratio = 1e-4)

plot(cv.lasso_ID)
plot(cv.lasso_ID$gamlr)

seg_ID <- str_c("seg", cv.lasso_ID$seg.min)

coef_ID <-
  coef(cv.lasso_ID, select = "min") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_ID) %>%
  filter(estimate != 0)
coef_ID %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting ID GDP growth (CV-LASSO MSE-minimizing lambda)") +
  coord_flip() +
  theme_bw()

# US
reg_US <- lm(`United States` ~ ., data = sparse_GDP_PPP %>% select(-1))
cv.lasso_US <- cv.gamlr(x = sparse_GDP_PPP %>% select(-1) %>% select(-`United States`),
                  y = sparse_GDP_PPP %>% select(`United States`),
                  lambda.min.ratio = 1e-4)

plot(cv.lasso_US)
plot(cv.lasso_US$gamlr)

seg_US <- str_c("seg", cv.lasso_US$seg.1se)

coef_US <-
  coef(cv.lasso_US, select = "1se") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_US) %>%
  filter(estimate != 0)
coef_US %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting US GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()

# Germaney
reg_DE <- lm(Germany ~ ., data = sparse_GDP_PPP %>% select(-1))
cv.lasso_DE <- cv.gamlr(x = sparse_GDP_PPP %>% select(-1) %>% select(-Germany),
                  y = sparse_GDP_PPP %>% select(Germany),
                  lambda.min.ratio = 1e-4)

plot(cv.lasso_DE)
plot(cv.lasso_DE$gamlr)

seg_DE <- str_c("seg", cv.lasso_DE$seg.1se)

coef_DE <-
  coef(cv.lasso_DE, select = "1se") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_DE) %>%
  filter(estimate != 0)
coef_DE %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting DE GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()
```

## LASSO and CV-LASSO for after 1990 (1990-2018)
### LASSO (Japan)
```{r}
# JP LASSO
reg_JP <- lm(Japan ~ ., data = sparse_GDP_PPP_after1990 %>% select(-1))

lasso_JP <- gamlr(x = sparse_GDP_PPP_after1990 %>% select(-1) %>% select(-Japan),
                  y = sparse_GDP_PPP_after1990 %>% select(Japan))

plot(lasso_JP)

seg_JP <- names(AICc(lasso_JP))[which.min(AICc(lasso_JP))]
(coef_JP <-
  coef(lasso_JP) %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_JP) %>%
  filter(estimate != 0))

coef_JP %>%
  ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting JP GDP growth (LASSO AICc-minimizing lambda)") +
  coord_flip() +
  theme_bw()
```

### CV-LASSO (Japan, Indonesia, US, Germany)
```{r}
# JP CV-LASSO
cv.lasso_JP <- cv.gamlr(x = sparse_GDP_PPP_after1990 %>% select(-1) %>% select(-Japan),
                  y = sparse_GDP_PPP_after1990 %>% select(Japan))

plot(cv.lasso_JP)
plot(cv.lasso_JP$gamlr)
seg_JP <- str_c("seg", cv.lasso_JP$seg.1se)
(coef_cv_JP <-
  coef(cv.lasso_JP, select = "1se") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_JP) %>%
  filter(estimate != 0))

coef_cv_JP %>%
  ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting JP GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()


# Indonesia
reg_ID <- lm(Indonesia ~ ., data = sparse_GDP_PPP_after1990 %>% select(-1))
cv.lasso_ID <- cv.gamlr(x = sparse_GDP_PPP_after1990 %>% select(-1) %>% select(-Indonesia),
                  y = sparse_GDP_PPP_after1990 %>% select(Indonesia),
                  lambda.min.ratio = 1e-6)

plot(cv.lasso_ID)
plot(cv.lasso_ID$gamlr)

seg_ID <- str_c("seg", cv.lasso_ID$seg.min)

coef_ID <-
  coef(cv.lasso_ID, select = "min") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_ID) %>%
  filter(estimate != 0)
coef_ID %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting ID GDP growth (CV-LASSO MSE-minimizing lambda)") +
  coord_flip() +
  theme_bw()

# US
reg_US <- lm(`United States` ~ ., data = sparse_GDP_PPP_after1990 %>% select(-1))
cv.lasso_US <- cv.gamlr(x = sparse_GDP_PPP_after1990 %>% select(-1) %>% select(-`United States`),
                  y = sparse_GDP_PPP_after1990 %>% select(`United States`),
                  lambda.min.ratio = 1e-4)

plot(cv.lasso_US)
plot(cv.lasso_US$gamlr)

seg_US <- str_c("seg", cv.lasso_US$seg.1se)

coef_US <-
  coef(cv.lasso_US, select = "1se") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_US) %>%
  filter(estimate != 0)
coef_US %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting US GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()

# Germaney
reg_DE <- lm(Germany ~ ., data = sparse_GDP_PPP_after1990 %>% select(-1))
cv.lasso_DE <- cv.gamlr(x = sparse_GDP_PPP_after1990 %>% select(-1) %>% select(-Germany),
                  y = sparse_GDP_PPP_after1990 %>% select(Germany),
                  lambda.min.ratio = 1e-4)

plot(cv.lasso_DE)
plot(cv.lasso_DE$gamlr)

seg_DE <- str_c("seg", cv.lasso_DE$seg.min)

coef_DE <-
  coef(cv.lasso_DE, select = "min") %>% as.matrix() %>% data.frame() %>% rownames_to_column() %>%
  rename(estimate = !!seg_DE) %>%
  filter(estimate != 0)
coef_DE %>% ggplot(aes(x = fct_reorder(rowname, estimate), y = estimate)) +
  geom_col() +
  labs(title = "Significant countries for predicting DE GDP growth (CV-LASSO 1se lambda)") +
  coord_flip() +
  theme_bw()
```

## FDR analysis (Japan)
```{r}
list_country <- sparse_GDP_PPP %>% select(-1) %>% colnames() %>%
  enframe() %>% rename(country = value)

reg_indiv <- function(data_, y_, x_) {
  df <- tibble(
    y_reg = data_ %>% select(!!y_) %>% .[[1]],
    x_reg = data_ %>% select(!!x_) %>% .[[1]])
  
  reg = lm(y_reg ~ x_reg, data = df)
  return(reg)
}

df_result <- list_country %>%
  mutate(model = future_map(country, ~ reg_indiv(sparse_GDP_PPP, "Japan", .)),
         tidied = future_map(model, tidy),
         glanced = future_map(model, glance),
         r.squared = future_map_dbl(glanced, ~ .[[1]]),
         adj.r.squared = future_map_dbl(glanced, ~ .[[2]]))


# FDR analysis
k <- 0.1 # FDR
impact_indiv <- 
  df_result %>% select(-3, -5) %>% unnest() %>%
  filter(term == "x_reg", country != "Japan") %>%
  mutate(rank = min_rank(p.value),
         cutoff = k * (rank / nrow(.)),
         null = if_else(p.value < cutoff, "rejected", "not rejected"))

# glance
impact_indiv %>%
  select(2, 4, 6, 7, 9, 12) %>%
  group_by(null) %>%
  arrange(p.value) %>%
  knitr::kable(didits = 3)

impact_indiv %>% count(null)

# histogram
impact_indiv %>%
  ggplot(aes(x = p.value)) + #skewed left
  geom_histogram() +
  labs(title = "Distribution of p-values (Japan ~ Each country)")
 
impact_indiv %>%
  group_by(null) %>%
  ggplot(aes(x = rank, y = p.value)) +
    geom_point(aes(color = null)) +
    stat_function(fun = function(x) k * x / nrow(impact_indiv)) +
    labs(title="BH procedure for regression of `Japan ~ Each country`")
```

